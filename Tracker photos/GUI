<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ESP32-CAM Gallery</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#0e1726" />

<style>
  :root {
    --bg:#0e1726; --panel:rgba(255,255,255,0.05); --ink:#f5f9ff;
    --muted:#b0c4de; --accent1:#00e5ff; --accent2:#4facfe;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 Helvetica,Arial,sans-serif;
       display:flex;height:100vh}
  .sidebar{
    width:320px;flex-shrink:0;padding:20px;overflow-y:auto;
    background:var(--panel);backdrop-filter:blur(12px);
    border-right:1px solid rgba(255,255,255,0.1);
    display:flex;flex-direction:column;gap:18px
  }
  h1{margin:0;font-size:1.4rem;font-weight:600}
  .actions button, .controls button, select, input{
    background:rgba(255,255,255,0.07);color:var(--ink);border:none;
    padding:10px 14px;border-radius:10px;font-size:0.9rem;cursor:pointer;width:100%
  }
  .actions button:hover, .controls button:hover{background:rgba(255,255,255,0.15)}
  .controls label{font-size:0.8rem;color:var(--muted);margin-bottom:4px;display:block}
  select,input{width:100%}
  .btnrow{display:flex;flex-wrap:wrap;gap:6px}
  .btnrow button{flex:1}
  .stat{font-size:0.85rem;color:var(--muted)}
  .main{flex:1;display:grid;grid-template-columns:1fr 220px;gap:20px;padding:20px;overflow:hidden}
  .featured{background:var(--panel);border-radius:16px;display:flex;flex-direction:column;
            box-shadow:0 10px 28px rgba(0,0,0,.35);padding:16px;overflow:auto}
  .feat-meta{font-size:0.9rem;color:var(--muted);margin-bottom:10px}
  .feat-img{flex:1;background:#000;border-radius:12px;display:flex;align-items:center;justify-content:center}
  .feat-img img{max-width:100%;max-height:100%;object-fit:contain}
  .thumbs{overflow-y:auto}
  .thumb-card{background:var(--panel);border-radius:10px;margin-bottom:12px;cursor:pointer;
              transition:transform .1s;box-shadow:0 6px 14px rgba(0,0,0,.25)}
  .thumb-card:hover{transform:translateY(-2px)}
  .thumb-card img{width:100%;display:block;aspect-ratio:4/3;object-fit:cover}
  .thumb-meta{padding:6px 8px;font-size:0.75rem;color:var(--muted)}
  footer{padding:8px;text-align:center;font-size:12px;color:var(--muted)}
  #jsonModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
  #jsonModal.active{display:flex}
  #jsonModal .modal-card{background:#fff;color:#000;border-radius:12px;max-width:900px;width:92%;
                         max-height:80vh;overflow:auto;padding:16px}
  #jsonContent{white-space:pre-wrap;font-size:12px;background:#f9fafb;padding:10px;border-radius:8px}
</style>
</head>
<body>

<!-- Sidebar controls -->
<div class="sidebar">
  <h1>ESP32-CAM Gallery</h1>
  <div class="actions">
    <button id="playBtn">▶ Slideshow</button>
    <button id="downloadZipBtn">Download ZIP</button>
    <button id="viewJsonBtn">View JSON</button>
  </div>

  <div class="controls">
    <label for="from">From</label><input type="datetime-local" id="from">
    <label for="to">To</label><input type="datetime-local" id="to">
    <label for="photoSelect">Jump to photo</label>
    <select id="photoSelect"><option value="">(Select…)</option></select>
  </div>

  <div class="btnrow">
    <button data-range="24h">24h</button>
    <button data-range="7d">7d</button>
    <button data-range="today">Today</button>
    <button data-range="all">All</button>
  </div>

  <div class="controls">
    <label for="sort">Sort</label>
    <select id="sort"><option value="new">Newest first</option><option value="old">Oldest first</option></select>
  </div>

  <div id="countStat" class="stat">0 photos</div>
</div>

<!-- Main area -->
<div class="main">
  <section class="featured">
    <div class="feat-meta" id="featMeta">—</div>
    <div class="feat-img"><img id="featured" alt="Selected photo"></div>
  </section>
  <aside class="thumbs" id="grid"></aside>
</div>


<!-- JSON Modal -->
<div id="jsonModal"><div class="modal-card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <h3 style="margin:0;font-size:18px">photos.json</h3>
    <button id="closeJsonBtn">Close</button>
  </div>
  <pre id="jsonContent"></pre>
</div></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
const JSON_FILE="photos.json", IMAGE_PATH="./", SLIDESHOW_MS=3000;
let all=[],filtered=[],playing=false,slideTimer=null,currentIndex=-1;
const $=s=>document.querySelector(s);

function pad(n){return String(n).padStart(2,"0");}
function parseNameToDate(name){
  const m=name.match(/^(\d{4})(\d{2})(\d{2})[_-](\d{2})(\d{2})(\d{2})\.(?:jpg|jpeg)$/i);
  if(!m) return null; const [_,Y,Mo,D,h,mi,s]=m.map(Number);
  return new Date(Y,Mo-1,D,h,mi,s);
}
function updateFeatured(i){
  if(i<0||i>=filtered.length)return;
  currentIndex=i; const it=filtered[i];
  $("#featured").src=IMAGE_PATH+it.name;
  $("#featMeta").textContent=`${it.name} • ${it.date?it.date.toLocaleString():"unknown"}`;
  $("#photoSelect").value=it.name;
}
function nextSlide(step=1){
  if(filtered.length===0)return;
  currentIndex=(currentIndex+step+filtered.length)%filtered.length;
  updateFeatured(currentIndex);
}
function startSlideshow(){if(playing||filtered.length<=1)return;
  playing=true;$("#playBtn").textContent="⏸ Pause";slideTimer=setInterval(()=>nextSlide(1),SLIDESHOW_MS);}
function stopSlideshow(){playing=false;$("#playBtn").textContent="▶ Slideshow";clearInterval(slideTimer);}
function renderGrid(list){
  const g=$("#grid"); g.innerHTML="";
  list.forEach((it,idx)=>{
    const c=document.createElement("div");c.className="thumb-card";
    c.innerHTML=`<img src="${IMAGE_PATH+it.name}" alt="${it.name}"><div class="thumb-meta">${it.name}</div>`;
    c.onclick=()=>{stopSlideshow();updateFeatured(idx);};
    c.ondblclick=()=>{window.open(IMAGE_PATH+it.name,"_blank");};
    g.appendChild(c);
  });
  $("#countStat").textContent=`${list.length} photo${list.length!==1?"s":""}`;
}
function applyFilter(){
  const sort=$("#sort").value;
  filtered=all.filter(x=>x.valid).sort((a,b)=>sort==="new"?b.date-a.date:a.date-b.date);
  renderGrid(filtered); if(filtered.length)updateFeatured(0);
  else{$("#featured").src="";$("#featMeta").textContent="No photos";}
}
async function init(){
  const res=await fetch(`${JSON_FILE}?t=${Date.now()}`);
  const names=await res.json();
  all=names.map(n=>({name:n,date:parseNameToDate(n),valid:!!parseNameToDate(n)}));
  applyFilter();
  $("#playBtn").onclick=()=>playing?stopSlideshow():startSlideshow();
  $("#downloadZipBtn").onclick=downloadZip;
  $("#viewJsonBtn").onclick=()=>{$("#jsonModal").classList.add("active");
    fetch(JSON_FILE).then(r=>r.json()).then(d=>$("#jsonContent").textContent=JSON.stringify(d,null,2));}
  $("#closeJsonBtn").onclick=()=>$("#jsonModal").classList.remove("active");
  document.querySelectorAll(".btnrow button").forEach(b=>b.onclick=()=>applyFilter());
  $("#sort").onchange=applyFilter;
}
async function downloadZip(){
  if(filtered.length===0)return;
  const zip=new JSZip();const f=zip.folder("photos");
  for(const it of filtered){const r=await fetch(IMAGE_PATH+it.name);f.file(it.name,await r.blob());}
  saveAs(await zip.generateAsync({type:"blob"}),"photos.zip");
}
init();
</script>
</body>
</html>
