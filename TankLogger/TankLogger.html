function applyFilter() {
  let startInput = document.getElementById('startDate').value;
  let endInput = document.getElementById('endDate').value;

  let start = startInput ? new Date(startInput + "T01:00:00") : new Date(-8640000000000000);
  let end = endInput ? new Date(endInput + "T23:59:59") : new Date(8640000000000000);

  const filtered = allData.filter(d => d.ts >= start && d.ts <= end);

  chart.data.datasets[0].data = filtered.filter(d => d.volume !== null).map(d => ({ x: d.ts, y: d.volume }));
  chart.data.datasets[1].data = filtered.filter(d => d.temp !== null).map(d => ({ x: d.ts, y: d.temp }));
  chart.update();

  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';

  filtered.slice().reverse().forEach((d, idx, arr) => {
    let netChange = "", rain = "";
    if (idx < arr.length - 1) {
      const prev = arr[idx + 1];
      const dt = (d.ts - prev.ts) / 1000 / 60;
      if (dt > 30 && dt < 90 && prev.volume !== null && d.volume !== null) {
        const diff = d.volume - prev.volume;
        if (Math.abs(diff) > NOISE_THRESHOLD) {
          netChange = (diff > 0)
            ? `<span class="pos">+${diff.toFixed(0)}</span>`
            : `<span class="neg">${diff.toFixed(0)}</span>`;
          if (diff > 0) {
            rain = (diff / ROOF_AREA).toFixed(1);
          }
        }
      }
    }
    tbody.insertAdjacentHTML('beforeend',
      `<tr>
         <td>${formatDateShort(d.ts)}</td>
         <td>${d.temp !== null ? d.temp.toFixed(1) : ''}</td>
         <td>${d.volume !== null ? d.volume.toFixed(0) : ''}</td>
         <td>${netChange}</td>
         <td>${rain}</td>
       </tr>`);
  });
}
