#include <Wire.h>
#include <HardwareSerial.h>
#include <TinyGPSPlus.h>
#include <Adafruit_BMP280.h>
#include "SparkFun_SCD4x_Arduino_Library.h"

#include <WiFi.h>
#include <WebServer.h>
#include <LittleFS.h>

// =======================
// I2C
// =======================
#define SDA_PIN 21
#define SCL_PIN 22

// =======================
// GPS (L80-R)
// =======================
#define GPS_RX 16
#define GPS_TX 17

HardwareSerial GPSSerial(2);
TinyGPSPlus gps;

// =======================
// SENSORS
// =======================
SCD4x scd41;
Adafruit_BMP280 bmp;

// =======================
// WIFI / SERVER
// =======================
WebServer server(80);

// =======================
// TIMING
// =======================
unsigned long lastLogTime = 0;
const unsigned long LOG_INTERVAL_MS = 30000;

// =======================
// FILE
// =======================
const char *DATA_FILE = "/data.csv";

// =======================
// HTML
// =======================
const char PAGE[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ESP32 Logger</title>
<style>
body{font-family:Helvetica;background:#f5f7fb;padding:20px}
.card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,0.1)}
table{width:100%;border-collapse:collapse;font-size:18px}
th,td{border:1px solid #e5e7eb;padding:6px;text-align:center}
th{background:#f8fafc}
button{font-size:22px;padding:12px 20px;margin:10px;border:none;border-radius:10px;background:#2563eb;color:#fff}
button:hover{background:#1e40af}
</style>
</head>
<body>

<div class="card">
<h2>Logged Data</h2>

<div style="overflow-x:auto">
<table id="tbl"></table>
</div>

<button onclick="download()">Download CSV</button>
<button onclick="clearData()">Clear Data</button>
</div>

<script>
function load(){
  fetch("/data",{cache:"no-store"})
    .then(r=>r.text())
    .then(csv=>{
      // âœ… BULLETPROOF LINE SPLIT
      let lines = csv.replace(/\r/g,"").trim().split("\n");

      let html = "<tr>";
      lines[0].split(",").forEach(h=>html += "<th>"+h+"</th>");
      html += "</tr>";

      for(let i=1;i<lines.length;i++){
        if(lines[i].trim()==="") continue;
        html += "<tr>";
        lines[i].split(",").forEach(c=>html += "<td>"+c+"</td>");
        html += "</tr>";
      }
      document.getElementById("tbl").innerHTML = html;
    });
}

function download(){ location="/download"; }
function clearData(){ fetch("/clear").then(()=>load()); }

setInterval(load,5000);
load();
</script>

</body>
</html>
)rawliteral";

// =======================
// SETUP
// =======================
void setup() {
  Serial.begin(9600);
  Wire.begin(SDA_PIN, SCL_PIN);

  GPSSerial.begin(9600, SERIAL_8N1, GPS_RX, GPS_TX);

  if (!scd41.begin()) {
    Serial.println("SCD41 not found!");
    while (1);
  }
  scd41.startPeriodicMeasurement();

  if (!bmp.begin(0x76)) {
    Serial.println("BMP280 not found!");
    while (1);
  }

  LittleFS.begin(true);
  if (!LittleFS.exists(DATA_FILE)) {
    File f = LittleFS.open(DATA_FILE, "w");
    f.println("time_s,co2_ppm,scd_temp_C,humidity_pct,pressure_Pa,bmp_temp_C,lat,lon,alt_m,sats");
    f.close();
  }

  WiFi.softAP("ESP32 Access Point", "");
  WiFi.softAPConfig(
    IPAddress(192,168,4,1),
    IPAddress(192,168,4,1),
    IPAddress(255,255,255,0)
  );

  server.on("/", [](){ server.send_P(200,"text/html",PAGE); });

  server.on("/data", [](){
    File f = LittleFS.open(DATA_FILE, "r");
    server.sendHeader("Cache-Control","no-store");
    server.streamFile(f,"text/plain");
    f.close();
  });

  server.on("/download", [](){
    File f = LittleFS.open(DATA_FILE, "r");
    server.streamFile(f,"text/csv");
    f.close();
  });

  server.on("/clear", [](){
    File f = LittleFS.open(DATA_FILE, "w");
    f.println("time_s,co2_ppm,scd_temp_C,humidity_pct,pressure_Pa,bmp_temp_C,lat,lon,alt_m,sats");
    f.close();
    server.send(200,"text/plain","CLEARED");
  });

  server.begin();
}

// =======================
// LOOP
// =======================
void loop() {
  server.handleClient();

  while (GPSSerial.available()) {
    gps.encode(GPSSerial.read());
  }

  unsigned long now = millis();

  if (now - lastLogTime >= LOG_INTERVAL_MS) {
    lastLogTime = now;

    if (!scd41.readMeasurement()) return;
    float co2 = scd41.getCO2();
    if (co2 == 0) return;

    float scdTemp = scd41.getTemperature();
    float humidity = scd41.getHumidity();
    float pressure = bmp.readPressure();
    float bmpTemp = bmp.readTemperature();
    bool fix = gps.location.isValid();

    String line = "";
    line += String(now/1000);
    line += "," + String(co2,1);
    line += "," + String(scdTemp,2);
    line += "," + String(humidity,2);
    line += "," + String(pressure,0);
    line += "," + String(bmpTemp,2);

    if (fix) {
      line += "," + String(gps.location.lat(),6);
      line += "," + String(gps.location.lng(),6);
      line += "," + String(gps.altitude.meters(),1);
      line += "," + String(gps.satellites.value());
    } else {
      line += ",,,,"; 
    }

    File f = LittleFS.open(DATA_FILE, "a");
    f.println(line);
    f.flush();
    f.close();

    Serial.println(line);
  }
}
